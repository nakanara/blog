# 클라우드 환경에서의 데브옵스 보안

> 줄리엔 비앙트 지음/ 홍성민, 주성식 옮김 (위키북스)

`글쓰기는 쉽다. 이마에 피땀이 맺힐 때까지 빈 종이를 응시하기만 하면 된다.`
`배는 항구에서 안전하지만, 그것이 배가 만들어진 목적은 아니다. -존 쉐드`


예제
* http://www.manning.com/books/securing-devops
* https://securing-devops.com/code


## 1부 사례 연구
### 데브옵스 보안
#### 데보옵스 접근법

데브옵스는 신속한 출시 주가, 통합 및 전달 파이프라인의 글로벌 자동화, 팀 간의 긴밀한 협업을 통해 소프트웨어 제품을 지속적으로 개선하는 프로세스

신속하고 꾸준히 개선되는 혁신적은 제품을 위해서는 개발 주기의 비용과 대기 시간을 줄이고, 고객 요구를 맞추기 위해서는 데브옵스를 채택

데브옵스 파이프라인의 주요 구성 요소는 개발자의 패치 제출에서 운영 환경으로 배포된 서비스를 완전 자동화 방식으로 진행하는 연속된 자동화 단계가 필요하며 그 과정을 완성하기 위해서는 지속적인 통합(CI: Continuous integraion), 지속적인 전달(CD: Continuos delivery), 서비스형 인프라(IaaS: Infrastructue as a service) 필요.


#### 지속적인 보안( Continuous security)

* 테스트 주도 보안(TDS: Test-driven security)
보안 테스트 후 기능 테스트(TDD: Test-driven develop)

* 사고 대응
> 보안 사고는 혼란을 야기하며 심지어 가장 안정적인 회사의 상태를 심각하게 손상할 수 있는 불확실성을 가져온다. 시스템 및 애플리케이션의 무결성을 복구하기 위해 서두르는 동안에 리더십은 피해 통제를 처리하고 비즈니스가 가능한 한 빨리 정상 운영 상태로 복귀할 수 있도록 보장해야 한다.


### 기본 데브옵스 파이프라인 구축하기

* 지속적인 통합, 웹훅을 통해 구성 요소와 통신해 코드를 테스트하고, 컨테이너를 빌드한다
* 수동 검토를 제외하고, CI/CD 파이프라인의 모든 단계는 완전히 자동화돼 있다.

### 보안 계층 1: 웹 애플리케이션 보호하기

취약점 점검 툴: OWASP Zed Attack Prox(ZAP) ![](https://zaproxy.org)

* XSS공격으로 방어 방법
  - 제출 시 사용자 입력 유효성을 검사한다. 
  - 사용자에게 반환된 모든 데이터를 페이지에서 렌더링하기 전에 이스케이프(Escape)처리.
  - 최신 웹 앱은 웹 브라우저에 내장된 보안 기능을 사용하며, 그중 가장 강력한 기능은 콘텐츠 보안 정책(CSP)!! Page(56)
> Content-Security-Policy: default-src 'self';  
[모질라 CSP](https://addons.mozilla.org)

```json
Content-Security-Policy:
  script-src # 인라인 스크립트를 포함한 스크립트 사이트
    'self'
    https://addons.mozilla.org;
  default-src
    'self';
  img-src  # HTML 랜더링 이미지 사이트
    'self';
  style-src
    'self'
    'unsafe-inline'; # 보호를 우회하고 HTML 요소 내부의 스타일 허용
  child-src # iframe 대상 사이트
    'self'
    'https://www.google.com/recaptcha/
  object-src: #플래시와 같은 모든 플러그인을 허용하지 않는다.
    'none';
  connect-src # ajax요청만 허용
    'self'; 
  font-src # 사이트와 CND에서 글꼴 로드
    'self'
    https://addons.cdn.mozilla.net
```

* 교차사이트 요청 위조

  - CSRP: 페이지를 어는 시점에 임의의 값을 클라이언트로 전송 전달받은 토큰을 해더에 기록, 해당 토큰을 요청시 함께 전달하여, 검증
  > SameSite 쿠키, 새로운 파라미터, CSRF공격에 대한 더 간단한 완화를 제공하기 위해 웹 브라우저에 통합, `SameSite=Strict` 속성 설정

* 클릭재킹(Clickjacking)
  > 웹페이지 위에 iframe로 투명한 레이어를 올린 후 사용자는 다른 사이트 버튼을 클릭하게 함으로써, 해를 끼침.

* 사용자인증
  - 암호관리 필요
  > 사용자 암호를 데이터 베이스에 저장하지 않고 비가역적 방식으로 암호를 저장, 저장 단계는 대략 다음과 같다.

  1. 일반 텍스트로 된 사용자 암호를 입력
  1. salt라 부르는 임의의 바이트 읽음
  1. 사용자 암호와 salt를 더해 H1 해시를 계산 H1=hash(password+salt)
  1. H1 해시와 salt를 데이터베이스에 저장

  - ID 제공자(IdP)
  > 최신 애플리케이션은 서드파트가 IdP 역할을 할 수 있어, 사용자는 각 사이트에 대해 새로운 계정을 생성하는 대신 ID 제공자 중 하나에서 보유한 계정을 사용해 애플리케이션에 로그인  
  > 싱글 사인 온(Single Sigin-ON, SSO), SAML(Security Assertion Markup Language)를 예전에는 많이 사용되었지만, 최근에는 OAuth2와 OpenID Connect는  SAML보다 애플리케이션에서 구현하기 쉬운 프로토콜을 정의해 인기.

  1. 사용자가 먼저 애필리케이션에 접근하고 로그인 메시지 표시
  1. 로그인 버튼은 질의 문자열에 사용자 지정 파라미터가 들어 있는 주소를 사용해 사용자를 IdP로 리디렉션
  1. IdP는 사용자에게 로그인을 위한 메시지 표시(존재하는 경우 기존 세션을 재사용) 사용자에게는 두 번째 리디렉션을 통해 애플리케이션으로 다시 보내짐
  1. 두 번째 리디렉션에는 애플리케이션이 토큰을 추출하고 교환하는 코드가 들어 있음
  1. API 토큰을 이용해 애플리케이션이 IdP에서 사용자 정보 검색
  1. 이 시점에서 사용자는 애플리케이션에 로그인돼 계속 사요

* 종속성 관리
  - 가용성 손실: 원본이 오프라인이거나 종속성의 개발자가 원본을 제거했을 수 있다. 또한 애플리케이션을 빌드하려는 서버가 인터넷에 접근하지 못할 수도 있다.
  - 무결성 손실: 소스 코드가 악의적인 것으로 대체될 수 있다.

**벤더링**: 개발자는 종종 종속성을 특정 버전으로 고정하고, 때로는 의존성 사본을 내려받아 프로젝트와 함께 저장.
  



### 보안 계층 2: 클라우드 인프라 보호하기


### 보안 계층 3: 통신 보안
### 보안 계층 4: 전달 파이프라인 보안

## 2부 이상징후 발견과 공격으로부터의 서비스 보호
### 로그 수집 및 저장하기
### 부정행위와 공격에 대한 로그 분석
### 침입 탐지
### 캐리비안 침해 사고: 침해 사고 대응 사례 연구

## 3부 데브옵스 보안을 성숙하게 만들기
### 위험평가
### 보안 테스트
### 지속적인 보안

## 용어 정리

* 풀리케스트? 
> '풀 리퀘스트'는 주어진 브랜치에서 다른 브랜치(일반적으로 기능과 마스터 브랜치)로 변경을 가져오기 위한 요청을 나타내는 용어로 깃허브에 의해 대중화, 개발자가 검토를 위해 패치를 제출하면 풀 리퀘스트가 열린다. 

* ELB - Elastic Load Balancing
* EC2 - Elastic Compute Cloud 
* RDB - Relational Database