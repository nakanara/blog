node {
  
  env.SERVER="remort-serv"

  env.BACKUP_SH_PATH="/home/user/conf/lightning/db_backup.sh"
  env.CURTIME = sh(returnStdout: true, script: "date +%Y%m%d%H%M%S").trim()
  env.BACKUP_FILE="${CURTIME}.sql"
  
  env.DUMP_KEEP_DAY="10"
  env.APP_ID  ="app"
  env.APP_PATH="webapps"
  env.DB_ID   ="mariadb"

  env.SLACK_CHANNEL = "#build"    

  try{

    slackSend channel: "${SLACK_CHANNEL}", color: "good", message: "Job: ${JOB_NAME} with buildnumber ${BUILD_NUMBER} 데이터 백업이 시작되었습니다."
    
    stage('SERVICE') {

      slackSend channel: "${SLACK_CHANNEL}", color: "good", message: "DB 백업 시작 ${SERVER} 서비스:${APP_ID}"      
      try {
        sh '''
          echo ${BACKUP_SH_PATH} ${APP_PATH} ${DB_ID} ${APP_ID}_${BACKUP_FILE} ${DUMP_KEEP_DAY}
          ssh ${SERVER} "${BACKUP_SH_PATH} ${APP_PATH} ${DB_ID} ${APP_ID}_${BACKUP_FILE} ${DUMP_KEEP_DAY}"
        '''
        slackSend channel: "${SLACK_CHANNEL}", color: "good", message: "DB 백업 성공 ${SERVER} 서비스:${APP_ID}"
      } catch (e) {          
        slackSend channel: "${SLACK_CHANNEL}", color: "danger", message: "DB 백업 실패 ${SERVER} ${APP_ID} ${APP_ID}_${BACKUP_FILE} ${DUMP_KEEP_DAY} // ${e}"
      }        
    
    }

  } catch(err){
      slackSend channel: "${SLACK_CHANNEL}", color: "danger", message: "Job: ${JOB_NAME} with buildnumber ${BUILD_NUMBER} 데이터 백업에 실패하였습니다. ${err}"
  } finally {
      slackSend channel: "${SLACK_CHANNEL}", color: "good", message: "Job: ${JOB_NAME} with buildnumber ${BUILD_NUMBER} 데이터 백업이 종료되었습니다."
  }
                        
}